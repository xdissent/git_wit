<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>GitWit by xdissent</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>GitWit</h1>
        <p>Dead simple Git hosting for Rails apps.</p>

        <p class="view"><a href="https://github.com/xdissent/git_wit">View the Project on GitHub <small>xdissent/git_wit</small></a></p>


        <ul>
          <li><a href="https://github.com/xdissent/git_wit/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/xdissent/git_wit/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/xdissent/git_wit">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <p><a href="https://travis-ci.org/xdissent/git_wit"><img src="https://travis-ci.org/xdissent/git_wit.png?branch=master" alt="Build Status"></a>
<a href="http://badge.fury.io/rb/git_wit"><img src="https://badge.fury.io/rb/git_wit.png" alt="Gem Version"></a></p>

<h2>Quickstart</h2>

<p>Create a Rails 3.2 app if you don't already have one. Add <code>git_wit</code> to your
Gemfile:</p>

<div class="highlight"><pre><span class="c1"># Use github for now - early development:</span>
<span class="n">gem</span> <span class="s2">"git_wit"</span><span class="p">,</span> <span class="n">git</span><span class="p">:</span> <span class="s2">"https://github.com/xdissent/git_wit.git"</span>

<span class="c1"># Later it might be safe to use a rubygems release:</span>
<span class="c1"># gem "git_wit", "~&gt; 0.1.0"</span>
</pre></div>

<p>Run <code>bundle install</code> followed by <code>rails g git_wit:install</code> and then checkout 
<a href="https://github.com/xdissent/git_wit/blob/master/lib/generators/git_wit/templates/git_wit.rb"><code>config/initializers/git_wit.rb</code></a>. 
You'll want to first change <code>config.repositories_path</code> to a folder where you'd 
like to store your repositories. Let's use "tmp/repositories" in our app root 
for fun:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">repositories_path</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"tmp"</span><span class="p">,</span> <span class="s2">"repositories"</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span>
</pre></div>

<p>Normally you wouldn't want to allow users to send their authentication 
credentials over an insecure protocol like HTTP, because they'll be sent in 
plain text over the wire. And since anonymous write access is always disallowed,
that means you can't safely push over HTTP without SSL. To disable these 
protections, something you'd <strong>never</strong> do in a production environment, change
the following config values in the initializer:</p>

<pre><code>config.insecure_auth = true
config.insecure_write = true
</code></pre>

<p>Now let's set up some simple (fake) authentication and authorization:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">authenticate</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">do</span>
  <span class="sx">%w(reader writer)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">user</span> <span class="o">==</span> <span class="n">password</span>
<span class="k">end</span>

<span class="n">config</span><span class="o">.</span><span class="n">authorize_read</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">repository</span><span class="p">)</span> <span class="k">do</span>
  <span class="sx">%w(reader writer)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">config</span><span class="o">.</span><span class="n">authorize_write</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">repository</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">==</span> <span class="s2">"writer"</span>
<span class="k">end</span>
</pre></div>

<p>What we've done is effectively create two users: <code>reader</code> and <code>writer</code>. Both can
read all repositories, but only <code>writer</code> may write (and can write to any repo.)
Both users are considered authenticated if the password matches the username.</p>

<p>Now your app is ready to start serving git repos over HTTP. Just create the 
repositories folder, initialize a repo and start the server:</p>

<div class="highlight"><pre><span class="gp">$</span> mkdir -p tmp/repositories
<span class="gp">$</span> git init --bare tmp/repositories/example.git
<span class="gp">$</span> rails s
</pre></div>

<p>Clone your repo, make some changes, and push:</p>

<div class="highlight"><pre><span class="gp">$</span> git clone http://localhost:3000/example.git
<span class="gp">$</span> <span class="nb">cd </span>example
<span class="gp">$</span> touch README
<span class="gp">$</span> git add README
<span class="gp">$</span> git commit -m <span class="s2">"First"</span>
<span class="gp">$</span> git push origin master
</pre></div>

<p>Your server will ask you for a username and password when you push - use 
<code>writer</code> for both and it should accept your changes.</p>

<h2>SSL</h2>

<p>You <strong>really</strong> should turn <code>insecure_auth</code> and <code>insecure_write</code> back to <code>false</code>
as quickly as possible and enable SSL for read/write access. GitWit doesn't 
need any special SSL configuration - just flip SSL on in whatever web server
is running Rails. You can also use the 
<a href="https://github.com/jugyo/tunnels">tunnels</a> gem to run your app with SSL in 
development. Just add it to the Gemfile and run <code>bundle install</code> followed by
<code>sudo tunnels</code> (or <code>rvmsudo tunnels</code> for RVM). For <code>rails s</code>, which runs on
port 3000 by default, run <code>sudo tunnels 443 3000</code>. Now you may clone 
repositories over HTTPS:</p>

<div class="highlight"><pre><span class="gp">$</span> git clone https://localhost/example.git
</pre></div>

<h2>A quick note about "local requests"</h2>

<p>The default Rails development environment has a config value called 
<code>consider_all_requests_local</code>, which is <code>true</code>. This prevents GitWit from 
correctly handling authentication responses in some cases. It's not a big deal,
you'll just be asked to reauthenticate more often and some responses will be
slightly misleading. But the alternative solution, which is to set 
<code>consider_all_requests_local</code> to false, disables any special Rails error 
handling - quite a bummer for development. It would be nice to sort this out a
little better in the future. Note that the production environment uses <code>false</code>
by default and handles errors approriately.</p>

<h2>Advanced Usage (Devise, Cancan, etc.)</h2>

<p>See <a href="https://github.com/xdissent/git_wit/tree/master/test/dummy"><code>test/dummy</code></a> 
for an example app that integrates 
<a href="https://github.com/plataformatec/devise">Devise</a>, 
<a href="https://github.com/ryanb/cancan">Cancan</a>, 
<a href="https://github.com/EppO/rolify">rolify</a> and
<a href="https://github.com/seyhunak/twitter-bootstrap-rails">twitter-bootstrap-rails</a>. 
Example controllers for managing repositories and public keys are included.</p>

<h2>SSH support - AKA: The hard part</h2>

<p>To enable git operations over SSH, you <strong>must have a dedicated SSH user</strong>. This
user will <em>only</em> be used for SSH autentication. Immediately after successfully
authenticating, the SSH user will <code>sudo</code> to the application user to continue
with the git operation. This eliminates the need for all the bat-shit crazy git
pulls/pushes and SSH wrappers and crap that are typical of gitolite/gitosis
setups. Your application user owns everything except the <code>authorized_keys</code> file
and the <code>ssh_user</code> only needs to know how to call the <code>gw-shell</code> command.</p>

<p>First, create a dedicated SSH user. On Mountain Lion:</p>

<div class="highlight"><pre><span class="gp">$</span> sudo dscl . -create /Groups/gitwit
<span class="gp">$</span> sudo dscl . -create /Groups/gitwit PrimaryGroupID 333
<span class="gp">$</span> sudo dscl . -create /Groups/gitwit RealName <span class="s2">"GitWit Server"</span>
<span class="gp">$</span> sudo dscl . -create /Users/gitwit UniqueID 333
<span class="gp">$</span> sudo dscl . -create /Users/gitwit PrimaryGroupID 333
<span class="gp">$</span> sudo dscl . -create /Users/gitwit NFSHomeDirectory /var/gitwit
<span class="gp">$</span> sudo dscl . -create /Users/gitwit UserShell /bin/bash
<span class="gp">$</span> sudo dscl . -create /Users/gitwit RealName <span class="s2">"GitWit Server"</span>
<span class="gp">$</span> sudo mkdir -p ~gitwit
<span class="gp">$</span> sudo chown -R gitwit:gitwit ~gitwit
</pre></div>

<p>Enable the <code>ssh_user</code> config value in <code>config/initializers/git_wit.rb</code>:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">ssh_user</span> <span class="o">=</span> <span class="s2">"gitwit"</span>
</pre></div>

<p>Now your application user needs to be allowed to <code>sudo</code> as <code>ssh_user</code> and vice
versa. Edit <code>/etc/sudoers</code> using <code>sudo visudo</code> and add the following lines:</p>

<pre><code>rails_user ALL=(gitwit) NOPASSWD:ALL
gitwit ALL=(rails_user) NOPASSWD:ALL
</code></pre>

<p>Replace <code>rails_user</code> with the application under which your Rails app runs, which
will be your personal username if using <code>rails s</code> or Pow.</p>

<p>Test your <code>sudo</code> rights and initialize the <code>ssh_user</code> environment:</p>

<div class="highlight"><pre><span class="gp">$</span> sudo -u gitwit -i
<span class="gp">$</span> mkdir .ssh
<span class="gp">$</span> chmod 700 .ssh
<span class="gp">$</span> touch .ssh/authorized_keys
<span class="gp">$</span> chmod 600 .ssh/authorized_keys
</pre></div>

<p>If you're using RVM or some other wacky environment manipulating tool, you're 
going to want to adjust the login environment for <code>ssh_user</code> by creating a
<code>~ssh_user/.bashrc</code> file. For example, to load a specific RVM gemset:</p>

<div class="highlight"><pre><span class="nb">source</span> <span class="s2">"/Users/xdissent/.rvm/environments/ruby-1.9.3-p385@git_wit"</span>
</pre></div>

<p>You may also need to adjust the <code>PATH</code> to include the location of the <code>gw-shell</code>
executable. If you're using <code>bundle --binstubs</code> for example:</p>

<div class="highlight"><pre><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/path/to/app/bin:$PATH"</span>
</pre></div>

<p>The <code>gw-shell</code> command handles the authentication and authorization for the SSH
protocol. It is initially called by <code>ssh_user</code> upon login (git operation) and it
will attempt to <code>sudo</code> to the application user and re-run itself with the same
environment. It determines which user is the "application user" by looking at
who owns the rails app root folder. To determine where the app root is actually
located, it looks for the ENV variables <code>RAILS_ROOT</code> and <code>BUNDLE_GEMFILE</code> in 
order. When in doubt, set <code>RAILS_ROOT</code> in <code>~ssh_user/.bashrc</code>:</p>

<div class="highlight"><pre><span class="nb">export </span><span class="nv">RAILS_ROOT</span><span class="o">=</span><span class="s2">"/path/to/app"</span>
</pre></div>

<p><strong>Remember to add <code>export RAILS_ENV="production"</code> for production deployments!</strong></p>

<p>You can easily sanity check your environment using <code>sudo</code> as your app user:</p>

<div class="highlight"><pre><span class="gp">$</span> sudo -u gitwit -i
<span class="gp">$</span> <span class="nb">source</span> .bashrc
<span class="gp">$</span> which gw-shell
<span class="go">/Users/xdissent/Code/git_wit/stubs/gw-shell</span>
<span class="gp">$</span> <span class="nb">echo</span> <span class="nv">$RAILS_ROOT</span>
<span class="go">/Users/xdissent/Code/git_wit/test/dummy</span>
</pre></div>

<p>Now all that's left to do is add some <code>authorized_keys</code> and you're all set. 
This can be done from the rails console (<code>rails c</code>):</p>

<div class="highlight"><pre><span class="no">GitWit</span><span class="o">.</span><span class="n">add_authorized_key</span> <span class="s2">"writer"</span><span class="p">,</span> <span class="s2">"ssh-rsa long-ass-key-string writer@example.com"</span>
<span class="c1"># =&gt; nil </span>
<span class="no">GitWit</span><span class="o">.</span><span class="n">authorized_keys_file</span><span class="o">.</span><span class="n">keys</span>
<span class="c1"># =&gt; [command="gw-shell writer",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa long-ass-key-string writer@example.com] </span>
</pre></div>

<p>You may now clone/push/pull over SSH - assuming the key you installed for 
<code>writer</code> is known to your ssh agent (ie <code>~/.ssh/id_rsa</code>):</p>

<div class="highlight"><pre><span class="gp">$</span> git clone gitwit@localhost:example.git
</pre></div>

<p>See the dummy app in 
<a href="https://github.com/xdissent/git_wit/tree/master/test/dummy"><code>test/dummy</code></a> for 
a more advanced example of <code>authorized_keys</code> management.</p>

<h2>Git hooks and configs and umasks and everything</h2>

<p>Dude, your app owns the repos now. Hooks are just files again! Rediscover the
<a href="https://github.com/mojombo/grit">grit</a> gem and go nuts with all kinds of fun
stuff that used to be a serious pain. Paranoid? Lock down the permissions on
your repositories folder so that only your application user can read it. The
SSH shell will still be executed as the application user so it's no sweat.</p>

<p>This project rocks and uses MIT-LICENSE.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/xdissent">xdissent</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>