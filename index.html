<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>GitWit by xdissent</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>GitWit</h1>
        <p>Dead simple Git hosting for Rails apps.</p>

        <p class="view"><a href="https://github.com/xdissent/git_wit">View the Project on GitHub <small>xdissent/git_wit</small></a></p>


        <ul>
          <li><a href="https://github.com/xdissent/git_wit/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/xdissent/git_wit/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/xdissent/git_wit">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <p><a href="http://badge.fury.io/rb/git_wit"><img src="https://badge.fury.io/rb/git_wit.png" alt="Gem Version"></a>
<a href="https://travis-ci.org/xdissent/git_wit"><img src="https://travis-ci.org/xdissent/git_wit.png?branch=master" alt="Build Status"></a>
<a href="https://gemnasium.com/xdissent/git_wit"><img src="https://gemnasium.com/xdissent/git_wit.png" alt="Dependency Status"></a>
<a href="https://codeclimate.com/github/xdissent/git_wit"><img src="https://codeclimate.com/github/xdissent/git_wit.png" alt="Code Climate"></a></p>

<h2>Crash Course</h2>

<p>Start hosting git repositories in seconds. Create a new Rails app and 
install GitWit:</p>

<div class="highlight"><pre><span class="gp">$</span> rails new example --skip-bundle; <span class="nb">cd </span>example       <span class="c"># New Rails app</span>
<span class="gp">$</span> <span class="nb">echo</span> <span class="s1">'gem "git_wit"'</span> &gt;&gt; Gemfile; bundle           <span class="c"># Install git_wit gem</span>
<span class="gp">$</span> rails g git_wit:install insecure_auth insecure_write authenticate authorize_read authorize_write
<span class="gp">$</span> rails s -d  <span class="c"># &lt;- Start Rails server               # ^- Install/config GitWit</span>
</pre></div>

<p>That's it - your app is hosting git repositories. Create a repositories folder,
init a bare repo, and push to it:</p>

<div class="highlight"><pre><span class="gp">$</span> git init; git add .; git commit -m <span class="s2">"That was easy"</span>
<span class="gp">$</span> mkdir repositories                                <span class="c"># Hosted repos folder</span>
<span class="gp">$</span> git init --bare repositories/example.git          <span class="c"># Example bare repo</span>
<span class="gp">$</span> git remote add origin http://localhost:3000/example.git
<span class="gp">$</span> git push origin master  <span class="c"># Push example app to itself to store in itself!</span>
</pre></div>

<p>HTTPS? That works too:</p>

<div class="highlight"><pre><span class="gp">$</span> sudo <span class="nb">echo</span> <span class="s2">"pre-loading sudo so we can background tunnels in a moment"</span>
<span class="gp">$</span> rails g git_wit:install authenticate authorize_read authorize_write -f
<span class="gp">$</span> <span class="nb">echo</span> <span class="s1">'gem "tunnels"'</span> &gt;&gt; Gemfile; bundle
<span class="gp">$</span> sudo tunnels 443 3000 &amp;       <span class="c"># or `rvmsudo tunnels...` if using RVM</span>
<span class="gp">$</span> git remote add https https://localhost/example.git
<span class="gp">$</span> <span class="nv">GIT_SSL_NO_VERIFY</span><span class="o">=</span>1 git push https master:https-master  <span class="c"># Trust yourself</span>
</pre></div>

<p>Still not impressed? Try SSH:</p>

<div class="highlight"><pre><span class="gp">$</span> rails g git_wit:install authenticate authorize_read authorize_write ssh_user:git_wit -f
<span class="gp">$</span> rails g git_wit:ssh_user      <span class="c"># Creates/configs git_wit SSH user</span>
<span class="gp">$</span> rake git_wit:ssh:add_key      <span class="c"># Grant access for ~/.ssh/id_rsa.pub</span>
<span class="gp">$</span> git remote add ssh git_wit@localhost:example.git
<span class="gp">$</span> git push ssh master:ssh-master
</pre></div>

<p>You might want to get rid of that system user you just created:</p>

<div class="highlight"><pre><span class="gp">$</span> rails d git_wit:ssh_user
</pre></div>

<h2>Overview</h2>

<p>GitWit adds git hosting abilities to any Rails app. It provides configurable
authentication and authorization methods that can be integrated with any 
user/repository access model you'd like. All configuration is handled through a
single initializer, 
<a href="https://github.com/xdissent/git_wit/blob/master/lib/generators/git_wit/templates/git_wit.rb"><code>config/initializers/git_wit.rb</code></a>. 
Run <code>rails g git_wit:install</code> to generate a default configuration for 
modification. All configuration details are contained within comments inside
the initializer, or read on for the highlights.</p>

<h2>Authentication</h2>

<p>Normally GitWit prevents the user from sending authentication credentials in
plaintext (via HTTP without SSL). To disable these protections, something you'd 
<strong>never</strong> do in a production environment, change the following config values 
in the initializer:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">insecure_auth</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="o">.</span><span class="n">insecure_write</span> <span class="o">=</span> <span class="kp">true</span>
</pre></div>

<p>Authentication is handled by the <code>config.authenticate</code> attribute. A valid
authenticator is any callable that accepts a user model instance and a 
clear-text password. The authenticator should return a boolean response 
indicating whether the user is authenticated for the given password. To allow
any user as long as the password matches the username:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">authenticate</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">==</span> <span class="n">password</span>
<span class="k">end</span>
</pre></div>

<p>The user model is simply the username as a string by default. Before passing
the user to the authenticator, GitWit will call <code>config.user_for_authenication</code>,
passing it the username and expecting a new user model instance in return. For
example:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">user_for_authentication</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">User</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">find_by_login</span> <span class="n">username</span><span class="p">:</span> <span class="n">username</span>
<span class="k">end</span>
</pre></div>

<p>Now the <code>config.authenticate</code> authenticator will recieve the <code>User</code> instance:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">authenticate</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">user</span><span class="o">.</span><span class="n">valid_password?</span> <span class="n">password</span>   <span class="c1"># user is a User</span>
<span class="k">end</span>
</pre></div>

<h2>Authorization</h2>

<p>Two configuration attributes are responsible for authorization: 
<code>config.authorize_read</code> and <code>config.authorize_write</code>. They're passed the user 
instance (already authenticated) and the repository path as a string. The 
repository path is relative to <code>config.repositories_path</code> 
(<code>&lt;app root&gt;/repositories</code> by default). The authorizers should return a boolean
to grant or deny access accordingly. A simple example:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">authorize_read</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">repository</span><span class="p">)</span> <span class="k">do</span>
  <span class="sx">%w(reader writer)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">config</span><span class="o">.</span><span class="n">authorize_write</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">repository</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">==</span> <span class="s2">"writer"</span>
<span class="k">end</span>
</pre></div>

<h2>A quick note about "local requests"</h2>

<p>The default Rails development environment has a config value called 
<code>consider_all_requests_local</code>, which is <code>true</code>. This prevents GitWit from 
correctly handling authentication responses in some cases. It's not a big deal,
you'll just be asked to re-authenticate more often and some responses will be
slightly misleading. But the alternative solution, which is to set 
<code>consider_all_requests_local</code> to <code>false</code>, disables any special Rails error 
handling - quite a bummer for development. It would be nice to sort this out a
little better in the future. Note that the production environment uses <code>false</code>
by default and handles errors appropriately.</p>

<h2>Advanced Usage (Devise, Cancan, etc.)</h2>

<p>See <a href="https://github.com/xdissent/git_wit/tree/master/test/dummy"><code>test/dummy</code></a> 
for an example app that integrates 
<a href="https://github.com/plataformatec/devise">Devise</a>, 
<a href="https://github.com/ryanb/cancan">Cancan</a>, 
<a href="https://github.com/EppO/rolify">rolify</a> and
<a href="https://github.com/seyhunak/twitter-bootstrap-rails">twitter-bootstrap-rails</a>. 
Example controllers for managing repositories and public keys are included.</p>

<h2>SSH support - AKA: The hard part</h2>

<p>To enable git operations over SSH, you <strong>must have a dedicated SSH user</strong>. This
user will <em>only</em> be used for SSH authentication. Immediately after successfully
authenticating, the SSH user will <code>sudo</code> to the application user to continue
with the git operation. This eliminates the need for all the bat-shit crazy git
pulls/pushes and SSH wrappers and crap that are typical of gitolite/gitosis
setups. Your application user owns everything except the <code>authorized_keys</code> file
and the <code>ssh_user</code> only needs to know how to call the <code>git_wit git-shell</code> 
command.</p>

<p>GitWit comes with an initializer to set everything up for you. First, enable the 
<code>ssh_user</code> config in <code>config/initializers/git_wit.rb</code>:</p>

<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">ssh_user</span> <span class="o">=</span> <span class="s2">"git_wit"</span>
</pre></div>

<p>Now run the initializer:</p>

<div class="highlight"><pre><span class="gp">$</span> rails g git_wit:ssh_user
</pre></div>

<p>To add a public key: <code>rake git_wit:ssh:add_key</code></p>

<p>Something not working? <code>rake git_wit:ssh:debug</code></p>

<h2>Git hooks and configs and umasks and everything</h2>

<p>Dude, your app owns the repos now. Hooks are just files again! Rediscover the
<a href="https://github.com/mojombo/grit">grit</a> gem and go nuts with all kinds of fun
stuff that used to be a serious pain. Paranoid? Lock down the permissions on
your repositories folder so that only your application user can read it. The
SSH shell will still be executed as the application user so it's no sweat.</p>

<p>This project rocks and uses MIT-LICENSE.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/xdissent">xdissent</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>